<!-- livebook:{"app_settings":{"access_type":"public","slug":"karel-dreams"}} -->

# Karel Dreams

```elixir
Mix.install([
  {:kino, "~> 0.11.0"},
  {:jason, "~> 1.4"},
  {:langchain, "~> 0.1.2"}
])
```

## Images

```elixir
defmodule Karel.Images do
  def robot do
    Map.new([:south, :north, :west, :east], &{&1, robot(&1)})
  end

  defp robot(:south) do
    """
    <svg viewBox="0 0 132.29166 132.29167" xmlns="http://www.w3.org/2000/svg" id="robot">
      <path
         id="karel-head"
         style="fill:#a87ace"
         d="m 40.01112,7.3210001 c -6.510779,0 -11.752254,5.2414759 -11.752254,11.7522539 v 29.929439 c 0,6.510778 5.241475,11.752254 11.752254,11.752254 h 52.26916 c 6.510777,0 11.75277,-5.241476 11.75277,-11.752254 V 19.073254 c 0,-6.510778 -5.241993,-11.7522539 -11.75277,-11.7522539 z M 37.856212,63.970771 c -0.415305,0.0019 -0.833544,0.01862 -1.25367,0.05064 -5.041508,0.384316 -10.352095,2.930711 -13.941784,7.506002 -4.786253,6.100388 -6.010195,15.862897 0.857828,28.006042 l 3.427698,-1.939933 c -6.347047,-11.22202 -4.959147,-18.824918 -1.185457,-23.63473 3.773689,-4.809811 10.437141,-6.773237 14.833719,-5.757788 l 0.886768,-3.837492 c -1.160308,-0.267988 -2.379186,-0.398371 -3.625102,-0.392741 z m 56.579492,0 c -1.245915,-0.0056 -2.464794,0.124753 -3.625102,0.392741 l 0.886768,3.837492 c 4.396577,-1.015449 11.06004,0.947977 14.83372,5.757788 3.77369,4.809812 5.1616,12.41271 -1.18545,23.634733 l 3.42769,1.939933 c 6.86803,-12.143145 5.64357,-21.905654 0.85731,-28.006042 -3.58968,-4.575291 -8.89975,-7.121686 -13.941263,-7.506002 -0.42013,-0.03203 -0.838368,-0.04877 -1.253673,-0.05064 z M 49.596955,99.085424 V 112.3456 c -0.379506,1.37909 -1.419306,2.38957 -2.675806,2.59984 h -1.455065 c -2.134296,0 -3.851962,1.68459 -3.851962,3.77754 v 7.14479 c 0,2.09296 1.717666,3.77806 3.851962,3.77806 h 14.511775 c 2.134297,0 3.852995,-1.6851 3.852995,-3.77806 v -7.14479 c 0,-2.09295 -1.718698,-3.77754 -3.852995,-3.77754 H 58.44241 c -1.256504,-0.21027 -2.296298,-1.22074 -2.675806,-2.59984 V 99.085424 Z m 26.882161,0 V 112.3456 c -0.379506,1.37909 -1.419306,2.38957 -2.675806,2.59984 h -1.490287 c -2.134295,0 -3.851961,1.68459 -3.851961,3.77754 v 7.14479 c 0,2.09296 1.717666,3.77806 3.851961,3.77806 h 14.512293 c 2.134297,0 3.852478,-1.6851 3.852478,-3.77806 v -7.14479 c 0,-2.09295 -1.718181,-3.77754 -3.852478,-3.77754 H 85.32457 c -1.256503,-0.21027 -2.296298,-1.22074 -2.675805,-2.59984 V 99.085424 Z" />
      <path
         id="karel-body"
         style="fill:#3dbcc0"
         d="m 54.52824,2.6458333 c -0.746052,0 -1.346688,0.600636 -1.346688,1.3466878 v 0.5105632 c 0,0.7460518 0.600636,1.3466878 1.346688,1.3466878 h 10.063468 v 1.471228 h 3.108337 V 5.8497721 H 77.76403 c 0.746053,0 1.346688,-0.600636 1.346688,-1.3466878 V 3.9925211 c 0,-0.7460518 -0.600635,-1.3466878 -1.346688,-1.3466878 z M 47.782915,60.754947 c -5.143282,0 -9.283671,4.140906 -9.283671,9.284188 v 23.643518 c 0,5.14328 4.140389,9.283667 9.283671,9.283667 h 36.725923 c 5.143282,0 9.284188,-4.140387 9.284188,-9.283667 V 70.039135 c 0,-5.143282 -4.140906,-9.284188 -9.284188,-9.284188 z M 28.177911,96.100593 a 7.4036958,6.2776936 46.631552 0 0 -0.856279,0.07751 7.4036958,6.2776936 46.631552 0 0 -2.960543,1.437121 7.4036958,6.2776936 46.631552 0 0 -1.603519,2.873736 7.4036958,6.2776936 46.631552 0 0 1.180806,5.62808 l 0.0036,-0.004 a 1.2535163,1.2535163 0 0 0 0.158647,0.20825 1.2535163,1.2535163 0 0 0 1.696537,0.11628 l 0.135393,-0.12764 a 1.2535163,1.2535163 0 0 0 0.02222,-0.0253 l 0.0021,0.002 3.485059,-3.2923 3.485575,-3.292315 -0.0015,-0.0021 a 1.2535163,1.2535163 0 0 0 0.02584,-0.02067 l 0.136426,-0.128158 A 1.2535163,1.2535163 0 0 0 33.068633,97.850416 1.2535163,1.2535163 0 0 0 32.869679,97.6804 l 0.0036,-0.0036 a 7.4036958,6.2776936 46.631552 0 0 -4.69532,-1.576648 z m 75.935939,0 a 6.2776936,7.4036958 43.368448 0 0 -4.695324,1.576648 l 0.004,0.0036 a 1.2535163,1.2535163 0 0 0 -0.19947,0.170016 1.2535163,1.2535163 0 0 0 -0.0191,1.700671 l 0.13591,0.128158 a 1.2535163,1.2535163 0 0 0 0.0264,0.02067 l -0.002,0.0021 3.485574,3.292314 3.48506,3.2923 0.002,-0.002 a 1.2535163,1.2535163 0 0 0 0.0222,0.0253 l 0.13539,0.12764 a 1.2535163,1.2535163 0 0 0 1.69654,-0.11628 1.2535163,1.2535163 0 0 0 0.15865,-0.20825 l 0.004,0.004 a 6.2776936,7.4036958 43.368448 0 0 1.18029,-5.62808 6.2776936,7.4036958 43.368448 0 0 -1.60352,-2.873735 6.2776936,7.4036958 43.368448 0 0 -2.96003,-1.437121 6.2776936,7.4036958 43.368448 0 0 -0.85679,-0.07751 z" />
      <path
         id="karel-k"
         style="fill:#ffffff"
         d="m 61.742687,85.892684 v 3.654422 h 1.191317 c 0.794205,0 1.357662,0.155623 1.690371,0.466868 0.343441,0.300508 0.515162,0.697611 0.515162,1.191308 0,0.482966 -0.171721,0.880069 -0.515162,1.191309 -0.332709,0.300513 -0.896166,0.45077 -1.690371,0.45077 h -5.006725 c -0.794205,0 -1.363028,-0.150257 -1.706469,-0.45077 -0.332709,-0.31124 -0.499064,-0.713709 -0.499064,-1.207406 0,-0.482966 0.17172,-0.874703 0.515161,-1.175211 0.343441,-0.311245 0.906899,-0.466868 1.690372,-0.466868 H 58.44244 V 76.635879 h -0.515161 c -0.794205,0 -1.363028,-0.150257 -1.706469,-0.45077 -0.332709,-0.31124 -0.499064,-0.713709 -0.499064,-1.207406 0,-0.493697 0.166355,-0.8908 0.499064,-1.191308 0.343441,-0.311245 0.912264,-0.466868 1.706469,-0.466868 l 5.006725,0.01607 c 0.794205,0 1.357662,0.150257 1.690371,0.45077 0.343441,0.300508 0.515162,0.697611 0.515162,1.191308 0,0.493698 -0.171721,0.896167 -0.515162,1.207406 -0.332709,0.300514 -0.896166,0.450771 -1.690371,0.450771 h -1.191317 v 4.894032 l 7.196408,-5.03892 c -0.34344,-0.246847 -0.579557,-0.477597 -0.708351,-0.69225 -0.128787,-0.214648 -0.193181,-0.477595 -0.193181,-0.78884 0,-0.504429 0.166355,-0.912264 0.499064,-1.223504 0.343441,-0.311245 0.912264,-0.466868 1.706469,-0.466868 l 3.364646,0.01607 c 0.794206,0 1.357663,0.150257 1.690372,0.45077 0.343441,0.300508 0.515161,0.697611 0.515161,1.191309 0,0.482965 -0.17172,0.880068 -0.515161,1.191308 -0.332709,0.311245 -0.858602,0.466868 -1.577679,0.466868 l -5.924355,5.183808 c 1.105452,0.633217 2.14114,1.599145 3.107065,2.897786 0.976664,1.298635 1.840632,2.908512 2.591904,4.829633 h 0.885435 c 0.783474,0 1.341565,0.155623 1.674274,0.466868 0.343441,0.300508 0.515161,0.697611 0.515161,1.191308 0,0.482965 -0.166354,0.880068 -0.499063,1.191308 -0.332709,0.300513 -0.896166,0.45077 -1.690372,0.45077 H 71.386111 C 70.69923,91.205235 69.947952,89.638286 69.132277,88.146461 68.466865,86.933686 68.044082,85.92072 67.44306,85.373363 66.85277,84.815269 65.753086,83.96452 64.926679,83.631811 Z" />
      <path
         id="karel-eye-white"
         style="fill:#ffffff"
         d="m 51.223488,22.149552 c -6.944679,-7.1e-5 -12.574497,5.629747 -12.574426,12.574426 -7.1e-5,6.944679 5.629747,12.574497 12.574426,12.574426 6.944679,7.1e-5 12.574497,-5.629747 12.574426,-12.574426 7.1e-5,-6.944679 -5.629747,-12.574497 -12.574426,-12.574426 z m 29.844689,0 c -6.944679,-7.1e-5 -12.574497,5.629747 -12.574426,12.574426 -7.1e-5,6.944679 5.629747,12.574497 12.574426,12.574426 6.944679,7.1e-5 12.574497,-5.629747 12.574426,-12.574426 7.1e-5,-6.944679 -5.629747,-12.574497 -12.574426,-12.574426 z" />
      <path
         id="karel-eye-dark"
         style="fill:#525252"
         d="m 51.223746,21.34185 c -7.381225,0 -13.383163,6.001419 -13.383163,13.382645 0,7.381227 6.001938,13.381095 13.383163,13.381095 7.381225,0 13.382645,-5.999868 13.382645,-13.381095 0,-7.381226 -6.00142,-13.382645 -13.382645,-13.382645 z m 29.844689,0 c -7.381224,0 -13.383162,6.001419 -13.383162,13.382645 0,7.381227 6.001938,13.381095 13.383162,13.381095 7.381226,0 13.382646,-5.999868 13.382646,-13.381095 0,-7.381226 -6.00142,-13.382645 -13.382646,-13.382645 z m -29.844689,1.615405 c 6.507904,0 11.76569,5.259338 11.76569,11.76724 0,6.507903 -5.257786,11.76569 -11.76569,11.76569 -6.507905,0 -11.76569,-5.257787 -11.76569,-11.76569 0,-6.507902 5.257785,-11.76724 11.76569,-11.76724 z m 29.844689,0 c 6.507905,0 11.76569,5.259338 11.76569,11.76724 0,6.507903 -5.257785,11.76569 -11.76569,11.76569 -6.507904,0 -11.76569,-5.257787 -11.76569,-11.76569 0,-6.507902 5.257786,-11.76724 11.76569,-11.76724 z m -29.844689,5.366597 c -3.534731,-1.01e-4 -6.400227,2.865396 -6.400126,6.400126 -1.01e-4,3.534731 2.865395,6.400227 6.400126,6.400126 3.53473,1.01e-4 6.400227,-2.865395 6.400126,-6.400126 1.01e-4,-3.53473 -2.865396,-6.400227 -6.400126,-6.400126 z m 29.844689,0 c -3.53473,-1.01e-4 -6.400227,2.865396 -6.400126,6.400126 -1.01e-4,3.534731 2.865396,6.400227 6.400126,6.400126 3.534731,1.01e-4 6.400227,-2.865395 6.400126,-6.400126 1.01e-4,-3.53473 -2.865395,-6.400227 -6.400126,-6.400126 z" />
      <path
         id="karel-eye-light"
         style="fill:#ffffff"
         d="m 51.223488,33.220711 a 1.5032583,1.5032583 0 0 0 -1.503268,1.503267 1.5032583,1.5032583 0 0 0 1.503268,1.503268 1.5032583,1.5032583 0 0 0 1.503267,-1.503268 1.5032583,1.5032583 0 0 0 -1.503267,-1.503267 z m 29.844689,0 a 1.5032583,1.5032583 0 0 0 -1.503267,1.503267 1.5032583,1.5032583 0 0 0 1.503267,1.503268 1.5032583,1.5032583 0 0 0 1.503268,-1.503268 1.5032583,1.5032583 0 0 0 -1.503268,-1.503267 z" />
    </svg>
    """
  end

  defp robot(:north) do
    """
    <svg viewBox="0 0 132.29166 132.29167" xmlns="http://www.w3.org/2000/svg" id="robot">
      <path
         id="karel-head"
         style="fill:#a87ace"
         d="m 92.28055,7.3210001 c 6.510779,0 11.75225,5.2414759 11.75225,11.7522539 v 29.929439 c 0,6.510778 -5.241471,11.752254 -11.75225,11.752254 H 40.01139 c -6.510777,0 -11.75277,-5.241476 -11.75277,-11.752254 V 19.073254 c 0,-6.510778 5.241993,-11.7522539 11.75277,-11.7522539 z m 2.154908,56.6497709 c 0.415305,0.0019 0.833544,0.01862 1.25367,0.05064 5.041512,0.384316 10.352092,2.930711 13.941782,7.506002 4.78626,6.100388 6.0102,15.862897 -0.85783,28.006042 l -3.42769,-1.939933 c 6.34704,-11.22202 4.95914,-18.824918 1.18545,-23.63473 -3.77369,-4.809811 -10.437138,-6.773237 -14.833716,-5.757788 l -0.886768,-3.837492 c 1.160308,-0.267988 2.379186,-0.398371 3.625102,-0.392741 z m -56.579492,0 c 1.245915,-0.0056 2.464794,0.124753 3.625102,0.392741 L 40.5943,68.201004 c -4.396577,-1.015449 -11.06004,0.947977 -14.83372,5.757788 -3.77369,4.809812 -5.1616,12.41271 1.18545,23.634733 l -3.42769,1.939933 C 16.65031,87.390313 17.87477,77.627804 22.66103,71.527416 c 3.58968,-4.575291 8.89975,-7.121686 13.941263,-7.506002 0.42013,-0.03203 0.838368,-0.04877 1.253673,-0.05064 z m 44.89034,35.114653 V 112.3456 c 0.379506,1.37909 1.419306,2.38957 2.675806,2.59984 h 1.403474 c 2.134296,0 3.851962,1.68459 3.851962,3.77754 v 7.14479 c 0,2.09296 -1.717666,3.77806 -3.851962,3.77806 H 72.313811 c -2.134297,0 -3.852995,-1.6851 -3.852995,-3.77806 v -7.14479 c 0,-2.09295 1.718698,-3.77754 3.852995,-3.77754 h 1.58704 c 1.256504,-0.21027 2.296298,-1.22074 2.675806,-2.59984 V 99.085424 Z m -26.928711,0 V 112.3456 c 0.379506,1.37909 1.419306,2.38957 2.675806,2.59984 h 1.485246 c 2.134295,0 3.851961,1.68459 3.851961,3.77754 v 7.14479 c 0,2.09296 -1.717666,3.77806 -3.851961,3.77806 H 45.466354 c -2.134297,0 -3.852478,-1.6851 -3.852478,-3.77806 v -7.14479 c 0,-2.09295 1.718181,-3.77754 3.852478,-3.77754 h 1.505787 c 1.256503,-0.21027 2.296298,-1.22074 2.675805,-2.59984 V 99.085424 Z" />
      <path
         id="karel-body"
         style="fill:#3dbcc0"
         d="m 77.76343,2.6458333 c 0.746052,0 1.346688,0.600636 1.346688,1.3466878 v 0.5105632 c 0,0.7460518 -0.600636,1.3466878 -1.346688,1.3466878 H 67.699962 v 1.471228 H 64.591625 V 5.8497721 H 54.52764 c -0.746053,0 -1.346688,-0.600636 -1.346688,-1.3466878 V 3.9925211 c 0,-0.7460518 0.600635,-1.3466878 1.346688,-1.3466878 z m 6.745325,58.1091137 c 5.143282,0 9.283671,4.140906 9.283671,9.284188 v 23.643518 c 0,5.14328 -4.140389,9.283667 -9.283671,9.283667 H 47.782832 c -5.143282,0 -9.284188,-4.140387 -9.284188,-9.283667 V 70.039135 c 0,-5.143282 4.140906,-9.284188 9.284188,-9.284188 z m 19.605005,35.345646 a 6.2776936,7.4036958 43.368448 0 1 0.85628,0.07751 6.2776936,7.4036958 43.368448 0 1 2.96054,1.437121 6.2776936,7.4036958 43.368448 0 1 1.60352,2.873736 6.2776936,7.4036958 43.368448 0 1 -1.18081,5.62808 l -0.004,-0.004 a 1.2535163,1.2535163 0 0 1 -0.15864,0.20825 1.2535163,1.2535163 0 0 1 -1.69654,0.11628 l -0.13539,-0.12764 a 1.2535163,1.2535163 0 0 1 -0.0222,-0.0253 l -0.002,0.002 -3.48506,-3.2923 -3.485577,-3.292315 0.0015,-0.0021 a 1.2535163,1.2535163 0 0 1 -0.02584,-0.02067 l -0.136426,-0.128158 a 1.2535163,1.2535163 0 0 1 0.01964,-1.700671 1.2535163,1.2535163 0 0 1 0.198954,-0.170016 l -0.0036,-0.0036 a 6.2776936,7.4036958 43.368448 0 1 4.695319,-1.576648 z m -75.93594,0 a 7.4036958,6.2776936 46.631552 0 1 4.695324,1.576648 l -0.004,0.0036 a 1.2535163,1.2535163 0 0 1 0.19947,0.170016 1.2535163,1.2535163 0 0 1 0.0191,1.700671 l -0.13591,0.128158 a 1.2535163,1.2535163 0 0 1 -0.0264,0.02067 l 0.002,0.0021 -3.485574,3.292314 -3.48506,3.2923 -0.002,-0.002 a 1.2535163,1.2535163 0 0 1 -0.0222,0.0253 l -0.13539,0.12764 a 1.2535163,1.2535163 0 0 1 -1.69654,-0.11628 1.2535163,1.2535163 0 0 1 -0.15865,-0.20825 l -0.004,0.004 a 7.4036958,6.2776936 46.631552 0 1 -1.18029,-5.62808 7.4036958,6.2776936 46.631552 0 1 1.60352,-2.873735 7.4036958,6.2776936 46.631552 0 1 2.96003,-1.437121 7.4036958,6.2776936 46.631552 0 1 0.85679,-0.07751 z" />
    </svg>
    """
  end

  defp robot(:west) do
    """
    <svg viewBox="0 0 132.29166 132.29167" xmlns="http://www.w3.org/2000/svg" id="robot">
      <path
         id="karel-body"
         style="fill:#3dbcc0"
         d="m 63.610443,2.6464844 c -0.746052,5.8e-6 -1.347655,0.5996511 -1.347656,1.3457031 v 0.5117187 c 0,0.7460521 0.601603,1.3457087 1.347656,1.3457032 h 10.0625 v 1.4707031 h 3.109375 V 5.8496094 h 10.0625 c 0.746053,-5.5e-6 1.347656,-0.5996511 1.347656,-1.3457032 V 3.9921875 c -10e-7,-0.7460422 -0.601606,-1.3456992 -1.347656,-1.3457031 z m 1.236328,58.1093746 c -5.143271,10e-7 -9.283206,4.139938 -9.283203,9.283203 v 23.644532 c 0,5.14327 4.139933,9.283206 9.283203,9.283206 h 19.128907 c 5.143272,0 9.283203,-4.139936 9.283203,-9.283206 V 70.039062 c 10e-7,-5.143274 -4.139932,-9.283205 -9.283203,-9.283203 z M 44.63974,91.595703 c -0.0437,-0.002 -0.08713,-6.32e-4 -0.130859,0.002 -0.652357,0.04082 -1.164589,0.57498 -1.175781,1.228516 l 0.01172,0.1875 c 0.0018,0.01129 0.0039,0.02221 0.0059,0.0332 h -0.002 l 0.298829,4.785156 0.298828,4.785155 h 0.002 c -9.95e-4,0.0114 2.52e-4,0.022 0,0.0332 l 0.01172,0.18555 c 0.09267,0.64688 0.666126,1.11497 1.318359,1.07422 0.08728,-0.006 0.173499,-0.0217 0.257812,-0.0449 v 0.006 c 2.037622,-0.49262 3.74926,-1.69552 4.705079,-3.30664 0.587675,-0.993276 0.860951,-2.095792 0.791015,-3.195305 -0.0675,-1.099512 -0.475016,-2.157991 -1.18164,-3.070313 C 49.67642,94.074397 49.483879,93.85909 49.276459,93.65625 48.124252,92.530124 46.525238,91.801479 44.7706,91.603516 v 0.0059 c -0.04329,-0.0065 -0.08716,-0.01167 -0.13086,-0.01367 z" />
      <path
         id="karel-eye"
         style="fill:#525252;fill-opacity:1;stroke-width:0.286486;-inkscape-stroke:none;stop-color:#000000"
         d="m 32.58085,21.34185 v 6.921541 h -2.35276 v 13.03848 h 2.35276 v 6.803719 h 3.078045 V 21.34185 Z" />
      <path
         id="karel-head"
         style="fill:#a87ace"
         d="m 47.412801,7.3203125 c -6.51076,0 -11.753906,5.2431485 -11.753906,11.7539065 v 29.927734 c 0,6.51076 5.243146,11.753906 11.753906,11.753906 h 42.898814 c 6.510757,0 11.751955,-5.243146 11.751955,-11.753906 V 19.074219 c 0,-6.510758 -5.241198,-11.7539065 -11.751955,-11.7539065 z m 30.396861,57.7949215 -4.865234,1.314454 c 2.419387,7.083437 0.233468,16.308873 -4.720704,21.001953 -4.806772,4.553449 -9.46984,6.289582 -18.140624,7.189453 0.562878,0.835361 0.889545,1.776033 0.949218,2.748047 0.06161,0.968553 -0.144488,1.939584 -0.595703,2.835939 12.865769,-1.245544 19.807375,-6.763755 22.726563,-10.271486 2.997642,-3.602006 7.927217,-14.323944 4.646484,-24.81836 z m -7.71875,37.851566 v 9.3789 c -0.37951,1.37909 -1.419285,2.38934 -2.675781,2.59961 h -2.748047 c -2.134286,0 -3.853516,1.6844 -3.853516,3.77735 v 7.14453 c 0,2.09296 1.71923,3.77929 3.853516,3.77929 h 14.511719 c 2.134284,0 3.851562,-1.68633 3.851562,-3.77929 v -7.14453 c 0,-2.09295 -1.049308,-3.77735 -3.183594,-3.77735 h -0.910156 c -1.256498,-0.21027 -2.296273,-1.22051 -2.675781,-2.59961 v -9.3789 z" />
    </svg>
    """
  end

  defp robot(:east) do
    """
    <svg viewBox="0 0 132.29166 132.29167" xmlns="http://www.w3.org/2000/svg" id="robot">
      <path
         id="karel-body"
         style="fill:#3dbcc0"
         d="m 68.681217,2.6464844 c 0.746052,5.8e-6 1.347655,0.5996511 1.347656,1.3457031 v 0.5117187 c 0,0.7460521 -0.601603,1.3457087 -1.347656,1.3457032 h -10.0625 V 7.3203125 H 55.509342 V 5.8496094 h -10.0625 C 44.700789,5.8496039 44.099186,5.2499583 44.099186,4.5039062 V 3.9921875 c 10e-7,-0.7460422 0.601606,-1.3456992 1.347656,-1.3457031 z M 67.444889,60.755859 c 5.143271,10e-7 9.283206,4.139938 9.283203,9.283203 v 23.644532 c 0,5.14327 -4.139933,9.283206 -9.283203,9.283206 H 48.315982 c -5.143272,0 -9.283203,-4.139936 -9.283203,-9.283206 V 70.039062 c -10e-7,-5.143274 4.139932,-9.283205 9.283203,-9.283203 z M 87.65192,91.595703 c 0.0437,-0.002 0.08713,-6.32e-4 0.130859,0.002 0.652357,0.04082 1.164589,0.57498 1.175781,1.228516 l -0.01172,0.1875 c -0.0018,0.01129 -0.0039,0.02221 -0.0059,0.0332 h 0.002 l -0.298829,4.785156 -0.298828,4.785155 h -0.002 c 9.95e-4,0.0114 -2.52e-4,0.022 0,0.0332 l -0.01172,0.18555 c -0.09267,0.64688 -0.666126,1.11497 -1.318359,1.07422 -0.08728,-0.006 -0.173499,-0.0217 -0.257812,-0.0449 v 0.006 c -2.037622,-0.49262 -3.74926,-1.69552 -4.705079,-3.30664 -0.587675,-0.993276 -0.860951,-2.095792 -0.791015,-3.195305 0.0675,-1.099512 0.475016,-2.157991 1.18164,-3.070313 0.174302,-0.224645 0.366843,-0.439952 0.574263,-0.642792 1.152207,-1.126126 2.751221,-1.854771 4.505859,-2.052734 v 0.0059 c 0.04329,-0.0065 0.08716,-0.01167 0.13086,-0.01367 z" />
      <path
         id="karel-eye"
         style="fill:#525252;fill-opacity:1;stroke-width:0.286486;-inkscape-stroke:none;stop-color:#000000"
         d="m 99.71081,21.34185 v 6.921541 h 2.35276 v 13.03848 H 99.71081 V 48.10559 H 96.632765 V 21.34185 Z" />
      <path
         id="karel-head"
         style="fill:#a87ace"
         d="m 84.878859,7.3203125 c 6.51076,0 11.753906,5.2431485 11.753906,11.7539065 v 29.927734 c 0,6.51076 -5.243146,11.753906 -11.753906,11.753906 H 41.980045 c -6.510757,0 -11.751957,-5.243146 -11.751957,-11.753906 V 19.074219 c 0,-6.510758 5.2412,-11.7539065 11.751957,-11.7539065 z m -30.396861,57.7949215 4.865234,1.314454 c -2.419387,7.083437 -0.233468,16.308873 4.720704,21.001953 4.806772,4.553449 9.46984,6.289582 18.140624,7.189453 -0.562878,0.835361 -0.889545,1.776033 -0.949218,2.748047 -0.06161,0.968553 0.144488,1.939584 0.595703,2.835939 C 68.989276,98.959536 62.04767,93.441325 59.128482,89.933594 56.13084,86.331588 51.201265,75.60965 54.481998,65.115234 Z m 7.71875,37.851566 v 9.3789 c 0.37951,1.37909 1.419285,2.38934 2.675781,2.59961 h 2.748047 c 2.134286,0 3.853516,1.6844 3.853516,3.77735 v 7.14453 c 0,2.09296 -1.71923,3.77929 -3.853516,3.77929 H 53.112857 c -2.134284,0 -3.851562,-1.68633 -3.851562,-3.77929 v -7.14453 c 0,-2.09295 1.049308,-3.77735 3.183594,-3.77735 h 0.910156 c 1.256498,-0.21027 2.296273,-1.22051 2.675781,-2.59961 v -9.3789 z" />
    </svg>
    """
  end

  def wall do
    """
    <svg viewBox="0 0 132.29201 132.29167" xmlns="http://www.w3.org/2000/svg">
      <rect
         style="fill:#ffffff"
         width="132.29166"
         height="132.29166"
         x="0"
         y="0" />
      <path
         style="fill:#acacac"
         d="M 4.7695312 0 C 3.2222028 -2.9605918e-16 1.9765625 1.2456366 1.9765625 2.7929688 L 1.9765625 12.625 C 1.9765625 14.172331 3.2222028 15.416016 4.7695312 15.416016 L 39.464844 15.416016 C 41.012175 15.416016 42.257812 14.172331 42.257812 12.625 L 42.257812 2.7929688 C 42.257812 1.2456366 41.012175 0 39.464844 0 L 4.7695312 0 z M 48.798828 0 C 47.2515 -2.9605918e-16 46.005859 1.2456366 46.005859 2.7929688 L 46.005859 12.625 C 46.005859 14.172331 47.2515 15.416016 48.798828 15.416016 L 83.494141 15.416016 C 85.041472 15.416016 86.287109 14.172331 86.287109 12.625 L 86.287109 2.7929688 C 86.287109 1.2456366 85.041471 0 83.494141 0 L 48.798828 0 z M 92.828125 0 C 91.280794 0 90.035156 1.2456366 90.035156 2.7929688 L 90.035156 12.625 C 90.035156 14.172331 91.280794 15.416016 92.828125 15.416016 L 127.52344 15.416016 C 129.07077 15.416016 130.31641 14.172331 130.31641 12.625 L 130.31641 2.7929688 C 130.31641 1.2456366 129.07077 -2.9605918e-16 127.52344 0 L 92.828125 0 z M 0 19.478516 L 0 22.271484 L 0 25.144531 L 0 29.230469 L 0 32.101562 L 0 34.894531 L 2.7929688 34.894531 L 5.6660156 34.894531 L 15.621094 34.894531 C 17.16842 34.894531 18.414062 33.64889 18.414062 32.101562 L 18.414062 22.271484 C 18.414062 20.724167 17.16842 19.478516 15.621094 19.478516 L 5.6660156 19.478516 L 2.7929688 19.478516 L 0 19.478516 z M 25.53125 19.478516 C 23.983919 19.478516 22.738281 20.724162 22.738281 22.271484 L 22.738281 32.101562 C 22.738281 33.64889 23.983919 34.896484 25.53125 34.896484 L 61.191406 34.896484 C 62.738739 34.896484 63.984375 33.64889 63.984375 32.101562 L 63.984375 22.271484 C 63.984375 20.724162 62.738739 19.478516 61.191406 19.478516 L 25.53125 19.478516 z M 71.101562 19.478516 C 69.554231 19.478516 68.308594 20.724162 68.308594 22.271484 L 68.308594 32.101562 C 68.308594 33.64889 69.554231 34.896484 71.101562 34.896484 L 106.75977 34.896484 C 108.3071 34.896484 109.55469 33.64889 109.55469 32.101562 L 109.55469 22.271484 C 109.55469 20.724162 108.3071 19.478516 106.75977 19.478516 L 71.101562 19.478516 z M 116.67188 19.478516 C 115.12455 19.478516 113.87891 20.724167 113.87891 22.271484 L 113.87891 32.101562 C 113.87891 33.64889 115.12455 34.894531 116.67188 34.894531 L 126.62695 34.894531 L 129.5 34.894531 L 132.29297 34.894531 L 132.29297 32.101562 L 132.29297 29.230469 L 132.29297 25.144531 L 132.29297 22.271484 L 132.29297 19.478516 L 129.5 19.478516 L 126.62695 19.478516 L 116.67188 19.478516 z M 4.7695312 38.958984 C 3.2222028 38.958984 1.9765625 40.204621 1.9765625 41.751953 L 1.9765625 51.583984 C 1.9765625 53.131316 3.2222028 54.375 4.7695312 54.375 L 39.464844 54.375 C 41.012175 54.375 42.257812 53.131316 42.257812 51.583984 L 42.257812 41.751953 C 42.257812 40.204621 41.012175 38.958984 39.464844 38.958984 L 4.7695312 38.958984 z M 48.798828 38.958984 C 47.2515 38.958984 46.005859 40.204621 46.005859 41.751953 L 46.005859 51.583984 C 46.005859 53.131316 47.2515 54.375 48.798828 54.375 L 83.494141 54.375 C 85.041472 54.375 86.287109 53.131316 86.287109 51.583984 L 86.287109 41.751953 C 86.287109 40.204621 85.041471 38.958984 83.494141 38.958984 L 48.798828 38.958984 z M 92.828125 38.958984 C 91.280794 38.958984 90.035156 40.204621 90.035156 41.751953 L 90.035156 51.583984 C 90.035156 53.131316 91.280794 54.375 92.828125 54.375 L 127.52344 54.375 C 129.07077 54.375 130.31641 53.131316 130.31641 51.583984 L 130.31641 41.751953 C 130.31641 40.204621 129.07077 38.958984 127.52344 38.958984 L 92.828125 38.958984 z M 0 58.4375 L 0 61.230469 L 0 64.103516 L 0 68.189453 L 0 71.060547 L 0 73.853516 L 2.7929688 73.853516 L 5.6660156 73.853516 L 15.621094 73.853516 C 17.16842 73.853516 18.414062 72.607872 18.414062 71.060547 L 18.414062 61.230469 C 18.414062 59.68315 17.16842 58.4375 15.621094 58.4375 L 5.6660156 58.4375 L 2.7929688 58.4375 L 0 58.4375 z M 25.53125 58.4375 C 23.983919 58.4375 22.738281 59.683145 22.738281 61.230469 L 22.738281 71.060547 C 22.738281 72.607872 23.983919 73.855469 25.53125 73.855469 L 61.191406 73.855469 C 62.738739 73.855469 63.984375 72.607872 63.984375 71.060547 L 63.984375 61.230469 C 63.984375 59.683145 62.738739 58.4375 61.191406 58.4375 L 25.53125 58.4375 z M 71.101562 58.4375 C 69.554231 58.4375 68.308594 59.683145 68.308594 61.230469 L 68.308594 71.060547 C 68.308594 72.607872 69.554231 73.855469 71.101562 73.855469 L 106.75977 73.855469 C 108.3071 73.855469 109.55469 72.607872 109.55469 71.060547 L 109.55469 61.230469 C 109.55469 59.683145 108.3071 58.4375 106.75977 58.4375 L 71.101562 58.4375 z M 116.67188 58.4375 C 115.12455 58.4375 113.87891 59.68315 113.87891 61.230469 L 113.87891 71.060547 C 113.87891 72.607872 115.12455 73.853516 116.67188 73.853516 L 126.62695 73.853516 L 129.5 73.853516 L 132.29297 73.853516 L 132.29297 71.060547 L 132.29297 68.189453 L 132.29297 64.103516 L 132.29297 61.230469 L 132.29297 58.4375 L 129.5 58.4375 L 126.62695 58.4375 L 116.67188 58.4375 z M 4.7695312 77.917969 C 3.2222028 77.917969 1.9765625 79.163605 1.9765625 80.710938 L 1.9765625 90.542969 C 1.9765625 92.0903 3.2222028 93.333984 4.7695312 93.333984 L 39.464844 93.333984 C 41.012175 93.333984 42.257812 92.0903 42.257812 90.542969 L 42.257812 80.710938 C 42.257812 79.163605 41.012175 77.917969 39.464844 77.917969 L 4.7695312 77.917969 z M 48.798828 77.917969 C 47.2515 77.917969 46.005859 79.163605 46.005859 80.710938 L 46.005859 90.542969 C 46.005859 92.0903 47.2515 93.333984 48.798828 93.333984 L 83.494141 93.333984 C 85.041472 93.333984 86.287109 92.0903 86.287109 90.542969 L 86.287109 80.710938 C 86.287109 79.163605 85.041471 77.917969 83.494141 77.917969 L 48.798828 77.917969 z M 92.828125 77.917969 C 91.280794 77.917969 90.035156 79.163605 90.035156 80.710938 L 90.035156 90.542969 C 90.035156 92.0903 91.280794 93.333984 92.828125 93.333984 L 127.52344 93.333984 C 129.07077 93.333984 130.31641 92.0903 130.31641 90.542969 L 130.31641 80.710938 C 130.31641 79.163605 129.07077 77.917969 127.52344 77.917969 L 92.828125 77.917969 z M 0 97.396484 L 0 100.18945 L 0 103.0625 L 0 107.14844 L 0 110.01953 L 0 112.8125 L 2.7929688 112.8125 L 5.6660156 112.8125 L 15.621094 112.8125 C 17.16842 112.8125 18.414062 111.56686 18.414062 110.01953 L 18.414062 100.18945 C 18.414062 98.642141 17.16842 97.396484 15.621094 97.396484 L 5.6660156 97.396484 L 2.7929688 97.396484 L 0 97.396484 z M 25.53125 97.396484 C 23.983919 97.396484 22.738281 98.642136 22.738281 100.18945 L 22.738281 110.01953 C 22.738281 111.56686 23.983919 112.8125 25.53125 112.8125 L 61.191406 112.8125 C 62.738739 112.8125 63.984375 111.56686 63.984375 110.01953 L 63.984375 100.18945 C 63.984375 98.642136 62.738739 97.396484 61.191406 97.396484 L 25.53125 97.396484 z M 71.101562 97.396484 C 69.554231 97.396484 68.308594 98.642136 68.308594 100.18945 L 68.308594 110.01953 C 68.308594 111.56686 69.554231 112.8125 71.101562 112.8125 L 106.75977 112.8125 C 108.3071 112.8125 109.55469 111.56686 109.55469 110.01953 L 109.55469 100.18945 C 109.55469 98.642136 108.3071 97.396484 106.75977 97.396484 L 71.101562 97.396484 z M 116.67188 97.396484 C 115.12455 97.396484 113.87891 98.642141 113.87891 100.18945 L 113.87891 110.01953 C 113.87891 111.56686 115.12455 112.8125 116.67188 112.8125 L 126.62695 112.8125 L 129.5 112.8125 L 132.29297 112.8125 L 132.29297 110.01953 L 132.29297 107.14844 L 132.29297 103.0625 L 132.29297 100.18945 L 132.29297 97.396484 L 129.5 97.396484 L 126.62695 97.396484 L 116.67188 97.396484 z M 4.7695312 116.875 C 3.2222028 116.875 1.9765625 118.12064 1.9765625 119.66797 L 1.9765625 129.5 C 1.9765625 131.04733 3.2222028 132.29102 4.7695312 132.29102 L 39.464844 132.29102 C 41.012175 132.29102 42.257812 131.04733 42.257812 129.5 L 42.257812 119.66797 C 42.257812 118.12064 41.012175 116.875 39.464844 116.875 L 4.7695312 116.875 z M 48.798828 116.875 C 47.2515 116.875 46.005859 118.12064 46.005859 119.66797 L 46.005859 129.5 C 46.005859 131.04733 47.2515 132.29102 48.798828 132.29102 L 83.494141 132.29102 C 85.041472 132.29102 86.287109 131.04733 86.287109 129.5 L 86.287109 119.66797 C 86.287109 118.12064 85.041471 116.875 83.494141 116.875 L 48.798828 116.875 z M 92.828125 116.875 C 91.280794 116.875 90.035156 118.12064 90.035156 119.66797 L 90.035156 129.5 C 90.035156 131.04733 91.280794 132.29102 92.828125 132.29102 L 127.52344 132.29102 C 129.07077 132.29102 130.31641 131.04733 130.31641 129.5 L 130.31641 119.66797 C 130.31641 118.12064 129.07077 116.875 127.52344 116.875 L 92.828125 116.875 z " />
    </svg>
    """
  end
end
```

## Code

```elixir
defmodule Karel.Board do
  defstruct [:cols, :rows, :walls, colors: %{}]

  def new(opts \\ []) do
    size = Keyword.get(opts, :size, 10)
    cols = Keyword.get(opts, :cols, size)
    rows = Keyword.get(opts, :rows, size)
    walls = MapSet.new(Keyword.get(opts, :walls, []))
    %__MODULE__{cols: cols, rows: rows, walls: walls}
  end

  def wall?(board, x, y) do
    not (x in 1..board.cols and y in 1..board.rows) or MapSet.member?(board.walls, {x, y})
  end

  def put_color(board, x, y, color) do
    put_in(board.colors[{x, y}], color)
  end

  def clear_color(board, x, y) do
    %{board | colors: Map.delete(board.colors, {x, y})}
  end

  def color(board, x, y) do
    Map.get(board.colors, {x, y})
  end
end

defmodule Karel.Robot do
  defstruct x: 1, y: 1, dir: :south

  def step(robot) do
    case robot.dir do
      :south -> %{robot | y: robot.y + 1}
      :north -> %{robot | y: robot.y - 1}
      :east -> %{robot | x: robot.x + 1}
      :west -> %{robot | x: robot.x - 1}
    end
  end

  def turn(robot, dir) do
    case {robot.dir, dir} do
      {:south, :left} -> %{robot | dir: :east}
      {:south, :right} -> %{robot | dir: :west}
      {:east, :left} -> %{robot | dir: :north}
      {:east, :right} -> %{robot | dir: :south}
      {:north, :left} -> %{robot | dir: :west}
      {:north, :right} -> %{robot | dir: :east}
      {:west, :left} -> %{robot | dir: :south}
      {:west, :right} -> %{robot | dir: :north}
    end
  end
end

defmodule Karel.Game do
  alias Karel.Board
  alias Karel.Robot

  defstruct [:board, :robot]

  def new(opts \\ []) do
    robot = %Robot{}
    walls = Keyword.get(opts, :walls, []) |> Enum.reject(&(&1 == {robot.x, robot.y}))
    %__MODULE__{board: Board.new(size: 10, walls: walls), robot: robot}
  end

  def step(game) do
    robot = Robot.step(game.robot)

    if not Board.wall?(game.board, robot.x, robot.y) do
      {:ok, %{game | robot: robot}}
    else
      {:error, :wall}
    end
  end

  def turn(game, dir) do
    robot = Robot.turn(game.robot, dir)
    %{game | robot: robot}
  end

  def put_color(game, color) do
    robot = game.robot
    %{game | board: Board.put_color(game.board, robot.x, robot.y, color)}
  end

  def clear_color(game) do
    robot = game.robot
    %{game | board: Board.clear_color(game.board, robot.x, robot.y)}
  end
end
```

```elixir
defmodule Karel.Kino do
  use Kino.JS
  use Kino.JS.Live
  alias Karel.Board
  alias Karel.Game
  alias Karel.Images

  def new(game) do
    Kino.JS.Live.new(__MODULE__, game)
  end

  def step(kino) do
    Kino.JS.Live.call(kino, :step)
  end

  def turn(kino, dir) when dir in [:left, :right] do
    Kino.JS.Live.call(kino, {:turn, dir})
  end

  def put_color(kino, color) do
    Kino.JS.Live.call(kino, {:put_color, color})
  end

  def clear_color(kino) do
    Kino.JS.Live.call(kino, :clear_color)
  end

  @impl true
  def init(game, ctx) do
    {:ok, assign(ctx, game: game)}
  end

  @impl true
  def handle_connect(ctx) do
    images = %{robot: Images.robot()}
    game = ctx.assigns.game

    data = %{
      cols: game.board.cols,
      html: html(game.board),
      images: images,
      x: game.robot.x,
      y: game.robot.y,
      dir: game.robot.dir
    }

    {:ok, data, ctx}
  end

  @impl true
  def handle_call(:step, _, ctx) do
    case Game.step(ctx.assigns.game) do
      {:ok, game} ->
        robot = game.robot
        broadcast_event(ctx, "step", %{x: robot.x, y: robot.y, dir: robot.dir})
        {:reply, :ok, assign(ctx, game: game)}

      {:error, _} = error ->
        {:reply, error, ctx}
    end
  end

  def handle_call({:turn, dir}, _, ctx) do
    game = Game.turn(ctx.assigns.game, dir)
    robot = game.robot
    broadcast_event(ctx, "turn", %{x: robot.x, y: robot.y, dir: robot.dir})
    {:reply, :ok, assign(ctx, game: game)}
  end

  def handle_call({:put_color, color}, _, ctx) do
    game = Game.put_color(ctx.assigns.game, color)
    robot = game.robot
    broadcast_event(ctx, "put-color", %{x: robot.x, y: robot.y, color: color})
    {:reply, :ok, assign(ctx, game: game)}
  end

  def handle_call(:clear_color, _, ctx) do
    game = Game.clear_color(ctx.assigns.game)
    robot = game.robot
    broadcast_event(ctx, "clear-color", %{x: robot.x, y: robot.y})
    {:reply, :ok, assign(ctx, game: game)}
  end

  defp html(board) do
    ~s|<div class="board">#{html_fields(board)}</div>|
  end

  defp html_fields(board) do
    for y <- 1..board.rows, x <- 1..board.cols do
      wall = if Board.wall?(board, x, y), do: Images.wall()
      color = Board.color(board, x, y)
      color = if color, do: ~s|style="--bg-color: #{color}"|
      ~s|<div id="board-field-#{x}-#{y}" #{color}>#{wall}</div>|
    end
  end

  asset "main.js" do
    """
    export function init(ctx, data) {
      document.querySelector(':root').style.setProperty('--board-cols', data.cols);
      ctx.importCSS("main.css")
      ctx.root.innerHTML = data.html
      fieldElement(data.x, data.y).innerHTML = data.images.robot[data.dir]

      ctx.handleEvent("step", (step) => {
        var robot = document.getElementById("robot")
        robot.remove()
        robot.setAttribute("data-move-dir", step.dir)
        fieldElement(step.x, step.y).appendChild(robot)
      });

      ctx.handleEvent("turn", (turn) => {
        var robot = document.getElementById("robot")
        robot.remove()
        fieldElement(turn.x, turn.y).innerHTML = data.images.robot[turn.dir]
      });

      ctx.handleEvent("put-color", (pc) => {
        fieldElement(pc.x, pc.y).style.setProperty('--bg-color', pc.color)
      });

      ctx.handleEvent("clear-color", (cc) => {
        fieldElement(cc.x, cc.y).style.removeProperty('--bg-color')
      });
    }

    function fieldElement(x, y) {
      return document.getElementById(fieldId(x, y))
    }

    function fieldId(x, y) {
      return `board-field-${x}-${y}`
    }
    """
  end

  asset "main.css" do
    """
    :root {
      --border-color: White;
      --border-size: 2px;
      --bg-color: LightGrey;
      --step-duration: 0.5s;
    }
    .board {
      background: var(--border-color);
      border: var(--border-size) solid var(--border-color);
      display: grid;
      grid-gap: var(--border-size);
      grid-template-columns: repeat(var(--board-cols), auto);
    }
    .board div {
      background: var(--bg-color);
      aspect-ratio: 1/1;
      position: relative;
    }
    .board div svg {
      position: absolute;
      width: 100%;
      z-index: 1;
    }
    svg[data-move-dir="south"] {
      animation-duration: var(--step-duration);
      animation-name: slideSouth;
    }
    @keyframes slideSouth {
      from { top: calc(-100% - var(--border-size)); }
      to { top: 0px; }
    }
    svg[data-move-dir="east"] {
      animation-duration: var(--step-duration);
      animation-name: slideEast;
    }
    @keyframes slideEast {
      from { left: calc(-100% - var(--border-size)); }
      to { left: 0px; }
    }
    svg[data-move-dir="north"] {
      animation-duration: var(--step-duration);
      animation-name: slideNorth;
    }
    @keyframes slideNorth {
      from { top: calc(100% + var(--border-size)); }
      to { top: 0px; }
    }
    svg[data-move-dir="west"] {
      animation-duration: var(--step-duration);
      animation-name: slideWest;
    }
    @keyframes slideWest {
      from { left: calc(100% + var(--border-size)); }
      to { left: 0px; }
    }
    """
  end
end
```

```elixir
defmodule Karel.AI do
  alias LangChain.Chains.LLMChain
  alias LangChain.ChatModels.ChatOpenAI
  alias LangChain.Message

  def openai_key() do
    case System.fetch_env("LB_OPENAI_KEY") do
      {:ok, key} ->
        Application.put_env(:langchain, :openai_key, key)
        :ok

      :error ->
        {:error, "OPENAI_KEY is not set in Secrets"}
    end
  end

  def init() do
    %{llm: ChatOpenAI.new!(%{model: "gpt-3.5-turbo"})}
    |> LLMChain.new!()
    |> LLMChain.add_messages([
      Message.new_system!("""
      You will translate text natural language to JSON.

      Here are a few examples:

      Input: Go one step forward.
      Output: ["step"]
      ---
      Input: Go two steps forward.
      Output: ["step", "step"]
      ---
      Input: Turn right.
      Output: ["turn-right"]
      ---
      Input: Go five steps forward, then turn right, then go three steps forward.
      Ouput: ["step", "step", "step", "step", "step", "turn-right", "step", "step", "step"]

      You reply will include only the content of the output, like this:
      ["turn-right", "step", "step", "turn-left", step", "turn-right", "step"]
      """)
    ])
    |> LLMChain.run()
  end

  def translate(updated_chain, text) do
    with {:ok, _updated_chain, response} <-
           updated_chain
           |> LLMChain.add_message(Message.new_user!(text))
           |> LLMChain.run() do
      {:ok, response.content}
    end
  end
end
```

```elixir
defmodule Karel do
  def run_script(karel, text) do
    with {:ok, script} <- parse_script(text) do
      Enum.reduce_while(script, :ok, fn instr, acc ->
        case cmd(karel, instr) do
          :ok -> {:cont, acc}
          error -> {:halt, error}
        end
      end)
    end
  end

  def run_ai(karel, chain, text) do
    with {:ok, script} <- Karel.AI.translate(chain, text) do
      Karel.run_script(karel, script)
    end
  end

  defp parse_script(text) do
    Jason.decode(text)
  end

  defp cmd(karel, "step") do
    with :ok <- Karel.Kino.step(karel) do
      Process.sleep(500)
      :ok
    end
  end

  defp cmd(karel, "turn-right") do
    with :ok <- Karel.Kino.turn(karel, :right) do
      Process.sleep(100)
      :ok
    end
  end

  defp cmd(karel, "turn-left") do
    with :ok <- Karel.Kino.turn(karel, :left) do
      Process.sleep(100)
      :ok
    end
  end

  defp cmd(karel, %{"put-color" => color}) do
    Karel.Kino.put_color(karel, color)
  end

  defp cmd(karel, "clear-color") do
    Karel.Kino.clear_color(karel)
  end
end
```

```elixir
defmodule Karel.UI do
  alias Kino.Layout

  def new do
    walls = [{5, 5}, {6, 5}, {2, 1}]
    karel = Karel.Kino.new(Karel.Game.new(walls: walls))

    step_button = Kino.Control.button("step")
    turn_left_button = Kino.Control.button("turn left")
    turn_right_button = Kino.Control.button("turn right")

    default_script = """
    [
      {"put-color": "red"},
      "step",
      "turn-left",
      "clear-color",
      "step",
      "turn-right"
    ]
    """

    script_text = Kino.Input.textarea("", default: default_script, monospace: true)
    script_form = Kino.Control.form([script: script_text], submit: "run")

    ai_text = Kino.Input.textarea("", default: "go 2 steps", monospace: true)
    ai_form = Kino.Control.form([script: ai_text], submit: "run")

    output = Kino.Frame.new()

    events = [
      step: step_button,
      turn_left: turn_left_button,
      turn_right: turn_right_button,
      script_form: script_form,
      ai_form: ai_form
    ]

    stream = Kino.Control.tagged_stream(events)

    Kino.listen(stream, %{out: [], output: output}, fn
      {:step, %{type: :click}}, state ->
        state = report(state, Karel.Kino.step(karel))
        {:cont, state}

      {:turn_left, %{type: :click}}, state ->
        state = report(state, Karel.Kino.turn(karel, :left))
        {:cont, state}

      {:turn_right, %{type: :click}}, state ->
        state = report(state, Karel.Kino.turn(karel, :right))
        {:cont, state}

      {:script_form, %{data: %{script: script}, type: :submit}}, state ->
        state = report(state, Karel.run_script(karel, script))
        {:cont, state}

      {:ai_form, %{data: %{script: script}, type: :submit}}, state ->
        state = info(state, "calling AI started")

        state =
          case init_ai(state) do
            {:ok, state} ->
              report(state, Karel.run_ai(karel, state.ai, script))

            error ->
              report(state, error)
          end

        state = info(state, "calling AI finished")
        {:cont, state}
    end)

    Layout.grid([
      Layout.grid(
        [
          karel,
          Layout.tabs(
            manual: Layout.grid([turn_left_button, step_button, turn_right_button], columns: 3),
            script: Layout.grid([script_form]),
            ai: Layout.grid([ai_form])
          )
        ],
        columns: 2
      ),
      output
    ])
  end

  defp init_ai(state) do
    case state[:ai] do
      nil ->
        with :ok <- Karel.AI.openai_key(),
             {:ok, chain, _response} <- Karel.AI.init() do
          {:ok, Map.put(state, :ai, chain)}
        end

      _chain ->
        {:ok, state}
    end
  end

  defp report(state, :ok) do
    state
  end

  defp report(state, {:error, _} = result) do
    info(state, result)
  end

  defp info(state, msg) do
    out = Enum.take([{"#{DateTime.utc_now(:millisecond)}", msg} | state.out], 10)
    Kino.Frame.clear(state.output)
    Enum.each(out, &Kino.Frame.append(state.output, &1))
    %{state | out: out}
  end
end
```

```elixir
Karel.UI.new()
```
